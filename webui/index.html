<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI é­”æ³•è¡£æ©±å¸ƒå±€ç¼–è¾‘å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Cropper removed: è§†é‡è£å‰ªåŠŸèƒ½å·²ä¸‹çº¿ -->
    <style>
        html, body { height: 100%; }
        .app-root { height: 100vh; }
        .main-root { position: fixed; top: 64px; left: 0; right: 0; bottom: 0; display: grid; grid-template-columns: 1fr 420px; grid-template-rows: 100%; overflow: hidden; }
        .scrollbar-thin::-webkit-scrollbar { width: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .asset-item { position: relative; }
        .asset-delete { position: absolute; top: -2px; right: -2px; width: 16px; height: 16px; background: #ef4444; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .asset-rename { position: absolute; top: -2px; right: 18px; width: 16px; height: 16px; background: #3b82f6; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .asset-item:hover .asset-delete, .asset-item:hover .asset-rename { opacity: 1; }
        .asset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        #preview-container { 
            --preview-pad: 20px; 
            min-height: 0; 
            height: 100%; 
            width: 100%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: radial-gradient(120% 120% at 20% 10%, #f8fbff 0%, #e7eef6 40%, #cfd9e6 100%); 
            position: relative; 
            overflow: hidden; 
            padding: var(--preview-pad); 
            user-select: none; 
            box-sizing: border-box; 
        }
        #canvas-preview { 
            position: relative;
            flex-shrink: 0;
            /* transform scale å®Œå…¨æ§åˆ¶ç¼©æ”¾ï¼Œæ— éœ€max-width/max-heighté™åˆ¶ */ 
        }
        .preview-panel { min-width: 0; min-height: 0; height: 100%; display: flex; flex-direction: column; }
        .control-panel { width: 420px; min-width: 320px; min-height: 0; height: 100%; overflow: hidden; display: flex; flex-direction: column; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .control-label { display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
        input[type="range"] { accent-color: #2563eb; }
        .draggable { cursor: move; pointer-events: auto !important; }
        .draggable:active { cursor: grabbing; color: #2563eb; }
        .box-handler { position: absolute; border: 2px dashed #3b82f6; background: rgba(59,130,246,0.1); }
        .glass-panel { background: linear-gradient(135deg, rgba(255,255,255,0.65), rgba(255,255,255,0.35)); backdrop-filter: blur(14px) saturate(140%); border: 1px solid rgba(255,255,255,0.35); box-shadow: 0 18px 50px rgba(24,35,55,0.18), inset 0 1px 0 rgba(255,255,255,0.6); }
        .dialogue-glow { position: absolute; inset: -8px; border-radius: 24px; background: radial-gradient(120% 120% at 10% 10%, rgba(255,255,255,0.55), rgba(255,255,255,0.05) 45%, rgba(99,102,241,0.18) 70%, rgba(15,23,42,0) 100%); filter: blur(12px); pointer-events: none; }
        .theme-layer { position: absolute; inset: 0; border-radius: inherit; pointer-events: none; }
        .theme-blue .theme-layer { background: linear-gradient(135deg, rgba(219,238,255,0.75), rgba(255,255,255,0.35)); border: 1px solid rgba(140,192,255,0.6); box-shadow: 0 16px 40px rgba(82,141,255,0.25), inset 0 1px 0 rgba(255,255,255,0.7); }
        .theme-wine .theme-layer { background: linear-gradient(135deg, rgba(88,20,45,0.78), rgba(255,180,210,0.18)); border: 1px solid rgba(255,160,200,0.6); box-shadow: 0 16px 36px rgba(120,20,60,0.28), inset 0 1px 0 rgba(255,230,245,0.3); }
        .theme-neon .theme-layer { background: linear-gradient(135deg, rgba(10,15,35,0.9), rgba(35,20,60,0.4)); border: 1px solid rgba(120,255,255,0.55); box-shadow: 0 0 40px rgba(80,255,255,0.4), inset 0 1px 0 rgba(180,255,255,0.45); }
        .ui-card { background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(245,248,255,0.85)); border: 1px solid rgba(148,163,184,0.25); border-radius: 20px; box-shadow: 0 14px 30px rgba(15,23,42,0.08); }
        .section-title { letter-spacing: 0.16em; font-size: 11px; font-weight: 900; color: #64748b; }
    </style>
</head>
<body class="bg-slate-50 h-screen overflow-hidden flex flex-col font-sans text-slate-900">
    <div id="app" class="app-root flex-1 flex flex-col min-h-0">
        <style v-if="fontFaceCss">{{ fontFaceCss }}</style>

        <header class="flex-none flex justify-between items-center bg-white px-6 py-3 border-b z-20 shadow-sm" style="height:64px;">
            <div class="flex items-center gap-6">
                <h1 class="text-xl font-black bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">âœ¨ GAL-Magic Editor</h1>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-bold text-slate-400">æ–¹æ¡ˆ:</span>
                    <select v-model="currentPreset" @change="loadLayout" class="bg-slate-100 border-none text-xs font-black py-1.5 px-4 rounded-full outline-none cursor-pointer">
                        <option v-for="p in assets.presets" :key="p" :value="p">{{p}}</option>
                    </select>
                    <button @click="createNewPreset" class="w-6 h-6 flex items-center justify-center bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition-colors">
                        <span class="text-lg font-bold">+</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-4">
                <button @click="saveLayout" class="bg-indigo-600 text-white px-8 py-2 rounded-full text-xs font-black hover:bg-indigo-700 shadow-md">ä¿å­˜å¸ƒå±€</button>
            </div>
        </header>

        <main class="main-root min-h-0">
            <!-- é¢„è§ˆåŒºåŸŸ (æ”¯æŒæ‹–æ‹½) -->
            <div id="preview-container" class="preview-panel" @mousemove="onDragMove" @mouseup="onDragEnd" @mouseleave="onDragEnd">
                <div id="canvas-preview" class="relative shadow-2xl bg-slate-900 overflow-hidden" :style="canvasStyle">
                    <!-- èƒŒæ™¯å±‚ -->
                    <div class="absolute inset-0" :style="previewBgStyle"></div>
                    
                    <!-- è§’è‰²å±‚ (æ”¯æŒæ°´å¹³æ‹–æ‹½) -->
                    <!-- è§’è‰²å±‚ï¼šæŒ‰é«˜åº¦ç¼©æ”¾ï¼Œå®½åº¦è‡ªé€‚åº” -->
                    <div class="absolute bottom-0 draggable transition-all duration-75" 
                         @mousedown="onDragStart($event, 'character')"
                         :style="characterLayerStyle">
                        <img v-if="layout.character_asset" 
                             :src="'/api/raw/character/' + encodeURIComponent(layout.character_asset)" 
                             :key="layout.character_asset"
                             @load="updateScale"
                             class="h-full w-auto object-contain pointer-events-none drop-shadow-2xl block" 
                             draggable="false" />
                    </div>

                    <!-- å¯¹è¯æ¡†å±‚ (æ”¯æŒè‡ªç”±æ‹–æ‹½) -->
                    <div v-if="showDialogueBox"
                         class="absolute draggable border border-white/20 glass-panel" :class="themeClass" 
                         @mousedown="onDragStart($event, 'box')"
                         :style="boxLayerStyle">
                        <div class="theme-layer"></div>
                        <div class="dialogue-glow"></div>
                        <img v-if="layout.border_asset" :src="'/api/raw/border/' + layout.border_asset" class="absolute inset-0 w-full h-full object-fill pointer-events-none z-10" draggable="false" />
                        <div class="relative z-20 pointer-events-none" :style="textStyle">é¢„è§ˆæ–‡æœ¬å†…å®¹...</div>
                    </div>

                    <!-- å§“åæ  -->
                    <div v-if="layout.show_name_box"
                         class="absolute glass-panel draggable" :class="themeClass"
                         @mousedown="onDragStart($event, 'name')"
                         :style="nameBoxStyle">
                        <div class="theme-layer"></div>
                        <div class="dialogue-glow"></div>
                        <div class="relative z-20 pointer-events-none" :style="nameTextStyle">{{ layout.name_text || 'è§’è‰²å' }}</div>
                    </div>


                    <!-- ç»„ä»¶/æ–‡æœ¬å›¾å±‚ -->
                    <div v-for="item in overlays" :key="item.id"
                         class="absolute rounded-md cursor-pointer transition-all duration-75"
                         :class="selectedOverlayId === item.id ? 'ring-2 ring-indigo-500' : 'ring-1 ring-white/10'"
                         :style="overlayStyle(item)"
                         @click.stop="selectOverlay(item.id)"
                         @mousedown.stop="onDragStart($event, 'overlay', item.id)">
                        <img v-if="item.type === 'image' && item.image" :src="componentSrc(item.image)" class="w-full h-full object-contain pointer-events-none" draggable="false" />
                        <div v-else class="w-full h-full whitespace-pre-wrap break-words pointer-events-none" :style="overlayTextStyle(item)">{{ item.text }}</div>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="control-panel bg-white border-l flex flex-col h-full shadow-2xl z-10">
                <div class="flex-1 overflow-y-auto scrollbar-thin p-6 space-y-6">
                    
                    <!-- ç”»å¸ƒè®¾ç½® -->
                    <section class="space-y-4">
                         <h3 class="section-title flex items-center justify-between">ğŸ“± ç”»é¢å°ºå¯¸ <span v-if="isDragging" class="text-blue-500 animate-pulse">æ­£åœ¨æ‹–æ‹½...</span></h3>
                         <div class="ui-card p-4 space-y-3">
                            <select v-model="resSelection" @change="applyResolution" class="w-full bg-white border p-2 rounded-xl text-xs font-bold font-mono outline-none">
                                <option value="1280x720">HD 1280x720 (16:9)</option>
                                <option value="1920x1080">FHD 1920x1080 (16:9)</option>
                                <option value="1024x1024">Square 1024x1024 (1:1)</option>
                                <option value="720x1280">Vertical 720x1280 (9:16)</option>
                                <option value="custom">è‡ªå®šä¹‰å°ºå¯¸...</option>
                            </select>
                            <div v-if="resSelection === 'custom'" class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="layout.canvas_width" @input="onCustomResolutionChange" class="bg-white border p-2 rounded-lg text-xs" placeholder="å®½åº¦">
                                <input type="number" v-model.number="layout.canvas_height" @input="onCustomResolutionChange" class="bg-white border p-2 rounded-lg text-xs" placeholder="é«˜åº¦">
                            </div>
                         </div>
                    </section>

                    <!-- æ¨¡å‹ä¸å‚è€ƒå›¾ -->
                    <section class="space-y-4">
                        <h3 class="section-title">ğŸ§  æ¨¡å‹ä¸å‚è€ƒå›¾</h3>
                        <div class="ui-card p-4 space-y-3">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-widest">æ¨¡å‹</div>
                            <select v-model="layout.model_name" class="w-full bg-white border p-2 rounded-xl text-xs font-bold font-mono outline-none">
                                <option v-for="name in Object.keys(models.models || {})" :key="name" :value="name">{{ name }}</option>
                            </select>
                            <div class="space-y-3">
                                <div v-for="slot in layout.model_slots" :key="slot.key" class="bg-white rounded-xl border p-3 space-y-2">
                                    <div class="flex items-center justify-between">
                                        <span class="text-[10px] font-black text-slate-500">æ§½ä½: {{ slot.key }}</span>
                                        <span class="text-[10px] text-slate-400">{{ slot.role }}</span>
                                    </div>
                                    <div class="grid grid-cols-3 gap-2">
                                        <select v-model="slot.role" class="bg-slate-100 rounded-lg p-2 text-xs">
                                            <option value="person">äººç‰©</option>
                                            <option value="scene">åœºæ™¯</option>
                                        </select>
                                        <input type="number" v-model.number="slot.weight" min="0" max="1" step="0.1" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="æƒé‡">
                                        <select v-model="slot.asset" class="bg-slate-100 rounded-lg p-2 text-xs">
                                            <option value="">(ä¸é€‰)</option>
                                            <option value="__ai__">AI ç”Ÿæˆ</option>
                                            <option v-for="item in slotAssets(slot.role)" :key="item" :value="item">{{ item }}</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- ç”Ÿæˆè®¾ç½®ï¼ˆè§’è‰²ï¼‰ -->
                    <section class="space-y-4">
                        <h3 class="section-title">âš™ï¸ è§’è‰²ç”Ÿæˆï¼ˆQwen-Editï¼‰</h3>
                        <div class="ui-card p-4 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="control-label"><span>æç¤ºè¯è´´åˆåº¦</span></label>
                                    <select v-model.number="layout.cfg_scale" class="w-full bg-white border p-2 rounded-lg text-xs font-bold">
                                        <option :value="2">2</option>
                                        <option :value="4">4</option>
                                        <option :value="6">6</option>
                                        <option :value="8">8</option>
                                        <option :value="10">10</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="control-label"><span>è¿­ä»£æ­¥æ•°</span></label>
                                    <select v-model.number="layout.num_inference_steps" class="w-full bg-white border p-2 rounded-lg text-xs font-bold">
                                        <option :value="10">10</option>
                                        <option :value="15">15</option>
                                        <option :value="20">20</option>
                                        <option :value="30">30</option>
                                        <option :value="40">40</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-400 leading-relaxed">
                                <div>CFG è¡¨ç¤ºæç¤ºè¯è´´åˆåº¦ï¼Œæ•°å€¼è¶Šé«˜è¶Šä¸¥æ ¼ä½†å¯èƒ½æ›´åƒµç¡¬ã€‚</div>
                            </div>
                        </div>
                    </section>

                    <!-- ç”Ÿæˆè®¾ç½®ï¼ˆèƒŒæ™¯ï¼‰ -->
                    <section class="space-y-4">
                        <h3 class="section-title">ğŸŒŒ åœºæ™¯ç”Ÿæˆï¼ˆèƒŒæ™¯æ¨¡å‹ï¼‰</h3>
                        <div class="ui-card p-4 space-y-3">
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="control-label"><span>èƒŒæ™¯æ¥æº</span></label>
                                    <select v-model="bgSource" class="w-full bg-white border p-2 rounded-lg text-xs font-bold">
                                        <option value="fixed">ä»…ç´ æï¼ˆå›ºå®šï¼‰</option>
                                        <option value="ai">AI ç”Ÿæˆï¼ˆä¸å¤ç”¨ï¼‰</option>
                                        <option value="auto">AI ç”Ÿæˆ/å¤ç”¨ï¼ˆæ ‡ç­¾ï¼‰</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="control-label"><span>AI èƒŒæ™¯æ¨¡å‹</span></label>
                                    <select v-model="layout.background_model" class="w-full bg-white border p-2 rounded-lg text-xs font-bold">
                                        <option value="Kwai-Kolors/Kolors">Kwai-Kolors/Kolors</option>
                                        <option value="Qwen/Qwen-Image">Qwen/Qwen-Image</option>
                                        <option value="Qwen/Qwen-Image-Edit">Qwen/Qwen-Image-Edit</option>
                                        <option value="Qwen/Qwen-Image-Edit-2509">Qwen/Qwen-Image-Edit-2509</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="control-label"><span>è¾“å‡ºå°ºå¯¸</span></label>
                                    <select v-model="layout.output_image_size" class="w-full bg-white border p-2 rounded-lg text-xs font-bold">
                                        <option value="1024x1024">1024x1024</option>
                                        <option value="1280x720">1280x720</option>
                                        <option value="1920x1080">1920x1080</option>
                                        <option value="720x1280">720x1280</option>
                                    </select>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-400 leading-relaxed">
                                <div>è¾“å‡ºå°ºå¯¸ä»…å¯¹ Kolors / Qwen-Image ç”Ÿæ•ˆï¼ŒQwen-Edit è¾“å‡ºå°ºå¯¸ç”±è¾“å…¥å›¾å†³å®šã€‚</div>
                            </div>
                        </div>
                    </section>

                    <!-- è¾“å‡ºæ¨¡å¼ -->
                    <section class="space-y-4">
                        <h3 class="section-title">ğŸ“¤ è¾“å‡ºæ¨¡å¼</h3>
                        <div class="ui-card p-4 space-y-3">
                            <select v-model="layout.output_mode" class="w-full bg-white border p-2 rounded-xl text-xs font-bold font-mono outline-none">
                                <option value="image_only">åªå‘å›¾</option>
                                <option value="image_text">å›¾ + å¤–ç½®æ–‡æœ¬</option>
                                <option value="image_tts">å›¾ + è¯­éŸ³</option>
                                <option value="image_text_tts">å›¾ + å¤–ç½®æ–‡æœ¬ + è¯­éŸ³</option>
                            </select>
                        </div>
                    </section>

                    <!-- æç¤ºè¯ä¸è¯·æ±‚é¢„è§ˆ -->
                    <section class="space-y-4">
                        <h3 class="section-title">ğŸ§¾ æç¤ºè¯ä¸è¯·æ±‚</h3>
                        <div class="ui-card p-4 space-y-3">
                            <textarea v-model="layout.prompt_extra" rows="2" class="w-full bg-white border p-2 rounded-lg text-xs" placeholder="è¿½åŠ åˆ°ç”Ÿæˆæç¤ºè¯æœ«å°¾ (prompt_extra)"></textarea>
                            <textarea v-model="layout.negative_prompt_extra" rows="2" class="w-full bg-white border p-2 rounded-lg text-xs" placeholder="è¿½åŠ åˆ°è´Ÿé¢æç¤ºè¯æœ«å°¾ (negative_prompt_extra)"></textarea>
                            <div class="flex items-center gap-3">
                                <button @click="refreshPayloadPreview" class="text-[10px] px-3 py-1 bg-slate-900 text-white rounded-full font-black">æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡è¯·æ±‚</button>
                                <button @click="refreshPromptPreview" class="text-[10px] px-3 py-1 bg-indigo-600 text-white rounded-full font-black">æŸ¥çœ‹æç¤ºè¯ç»“æ„</button>
                                <span v-if="payloadPreview && payloadPreview.timestamp" class="text-[10px] text-slate-400">æ›´æ–°æ—¶é—´: {{ new Date(payloadPreview.timestamp * 1000).toLocaleTimeString() }}</span>
                            </div>
                            <pre v-if="payloadPreview" class="text-[10px] bg-white border rounded-xl p-3 max-h-40 overflow-auto">{{ JSON.stringify(payloadPreview.payload || payloadPreview, null, 2) }}</pre>
                            <div v-if="promptPreview && promptPreview.preview" class="bg-white border rounded-xl p-3 space-y-2 text-[11px] text-slate-600">
                                <div class="font-bold text-slate-700">æ¨¡å‹</div>
                                <div class="font-mono text-[10px]">{{ promptPreview.preview.model }}</div>
                                <div class="font-bold text-slate-700">æ­£å‘æç¤ºè¯ç»“æ„</div>
                                <div class="space-y-1">
                                    <div><span class="font-semibold">åŸºç¡€/åŠ¨ä½œï¼š</span>{{ (promptPreview.preview.prompt_parts || []).join(', ') }}</div>
                                    <div><span class="font-semibold">èƒŒæ™¯æç¤ºï¼š</span>{{ promptPreview.preview.background_hint }}</div>
                                    <div><span class="font-semibold">è¿½åŠ ï¼š</span>{{ promptPreview.preview.prompt_extra }}</div>
                                </div>
                                <div class="font-bold text-slate-700">æœ€ç»ˆæ­£å‘</div>
                                <div class="text-[10px] font-mono break-words">{{ promptPreview.preview.final_prompt }}</div>
                                <div class="font-bold text-slate-700">è´Ÿé¢æç¤ºè¯ç»“æ„</div>
                                <div class="space-y-1">
                                    <div><span class="font-semibold">åŸºç¡€ï¼š</span>{{ promptPreview.preview.negative?.base }}</div>
                                    <div><span class="font-semibold">ç¨³å®šæ€§ï¼š</span>{{ promptPreview.preview.negative?.stability_negative }}</div>
                                    <div><span class="font-semibold">è¿½åŠ ï¼š</span>{{ promptPreview.preview.negative?.negative_extra }}</div>
                                </div>
                                <div class="font-bold text-slate-700">æœ€ç»ˆè´Ÿé¢</div>
                                <div class="text-[10px] font-mono break-words">{{ promptPreview.preview.negative?.final_negative }}</div>
                            </div>
                        </div>
                    </section>

                    <!-- èƒŒæ™¯é…ç½® -->
                    <section class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest flex items-center gap-2">
                                ğŸ–¼ï¸ èƒŒæ™¯åœºæ™¯
                            </h4>
                            <div class="flex gap-2">
                                <button @click="triggerUpload('background')" class="text-[10px] px-3 py-1 bg-slate-900 text-white rounded-full font-black">UPLOAD</button>
                            </div>
                        </div>
                        <input type="file" id="upload-background" hidden @change="uploadFile($event, 'background')">
                        <div class="asset-grid p-2 ui-card max-h-[160px] overflow-y-auto">
                            <div v-for="item in assets.backgrounds" class="asset-item aspect-square cursor-pointer rounded-xl overflow-hidden border-2" :class="layout.background_asset === item ? 'border-indigo-600' : 'border-transparent'">
                                <div class="asset-delete" @click.stop="deleteAsset('background', item)">Ã—</div>
                                <div class="asset-rename" @click.stop="renameAsset('background', item)">âœ</div>
                                <img @click="changeBackground(item)" :src="'/api/raw/background/' + item" class="w-full h-full object-cover">
                                <div class="absolute inset-x-0 bottom-0 bg-black/60 text-white text-[9px] leading-tight px-1 py-0.5 truncate">{{ item }}</div>
                            </div>
                        </div>
                    </section>

                    <!-- è§’è‰²ç«‹ç»˜ -->
                    <section class="space-y-3">
                        <div class="flex justify-between items-center border-b pb-1">
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">ğŸ‘¤ è§’è‰²ç«‹ç»˜</h4>
                            <button @click="triggerUpload('character')" class="text-[10px] px-3 py-1 bg-slate-100 rounded-full font-black">UPLOAD</button>
                        </div>
                        <input type="file" id="upload-character" hidden @change="uploadFile($event, 'character')">
                        <div class="asset-grid p-2 ui-card max-h-[160px] overflow-y-auto">
                            <div v-for="item in assets.characters" class="asset-item aspect-square cursor-pointer rounded-xl border-2 flex items-center justify-center overflow-hidden" :class="layout.character_asset === item ? 'border-indigo-600 bg-white' : 'border-transparent'">
                                <div class="asset-delete" @click.stop="deleteAsset('character', item)">Ã—</div>
                                <div class="asset-rename" @click.stop="renameAsset('character', item)">âœ</div>
                                <img @click="layout.character_asset = item" :src="'/api/raw/character/' + item" class="w-full h-full object-contain p-0.5">
                            </div>
                        </div>
                        <div class="ui-card p-4 space-y-2">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-widest">ä½ç½®ä¸å°ºå¯¸</div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="layout.character_left" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="Xåæ ‡">
                                <input type="number" v-model.number="layout.character_width" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å®½åº¦">
                            </div>
                            <p class="text-[11px] text-slate-400">
                                â€¢ å¯ç›´æ¥åœ¨é¢„è§ˆåŒºæ‹–åŠ¨ç«‹ç»˜ä½ç½®ï¼ˆä»…Xè½´ï¼‰<br>
                                â€¢ è§’è‰²å®½åº¦å½±å“AIç”Ÿæˆå›¾å’Œä¸Šä¼ ç«‹ç»˜çš„ç¼©æ”¾<br>
                                â€¢ å»ºè®®å€¼ï¼š1280x720ç”»å¸ƒ â†’ å®½åº¦500-700
                            </p>
                        </div>
                    </section>

                    <!-- å¯¹è¯æ¡† -->
                    <section class="space-y-4">
                        <div class="flex justify-between items-center"><h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">ğŸ’¬ å¯¹è¯æ¡†</h4><button @click="triggerUpload('border')" class="text-[10px] px-3 py-1 bg-slate-100 rounded-full font-black">UPLOAD</button></div>
                        <input type="file" id="upload-border" hidden @change="uploadFile($event, 'border')">
                        <div class="ui-card p-3">
                            <div class="grid grid-cols-2 gap-2 items-center">
                                <span class="text-xs font-bold text-slate-600">é¢„è§ˆæ˜¾ç¤ºå¯¹è¯æ¡†</span>
                                <select v-model="layout.enable_dialogue_box" class="bg-white border p-2 rounded-lg text-xs font-bold">
                                    <option :value="true">æ˜¾ç¤º</option>
                                    <option :value="false">éšè—</option>
                                </select>
                            </div>
                            <div class="flex justify-end pt-2">
                                <button @click="resetDialogueBox" class="text-[10px] px-3 py-1 bg-indigo-50 text-indigo-700 rounded-full font-black">é‡ç½®ä½ç½®</button>
                            </div>
                        </div>
                        <div class="ui-card p-4 space-y-3">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-widest">ä¸»é¢˜é¢„è®¾</div>
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="applyThemePreset('blue')" class="text-[10px] px-2 py-1 rounded-full bg-blue-50 text-blue-700 font-black">è“è‰²æ¸…æ–°</button>
                                <button @click="applyThemePreset('wine')" class="text-[10px] px-2 py-1 rounded-full bg-rose-50 text-rose-700 font-black">é…’çº¢ä¼˜é›…</button>
                                <button @click="applyThemePreset('neon')" class="text-[10px] px-2 py-1 rounded-full bg-cyan-50 text-cyan-700 font-black">éœ“è™¹ç§‘æŠ€</button>
                            </div>

                            <div class="text-xs font-black text-slate-500 uppercase tracking-widest">å§“åæ </div>
                            <div class="grid grid-cols-2 gap-2 items-center">
                                <span class="text-xs font-bold text-slate-600">æ˜¾ç¤ºå§“åæ </span>
                                <select v-model="layout.show_name_box" class="bg-white border p-2 rounded-lg text-xs font-bold">
                                    <option :value="true">æ˜¾ç¤º</option>
                                    <option :value="false">éšè—</option>
                                </select>
                            </div>
                            <input type="text" v-model="layout.name_text" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å§“åæ–‡æœ¬">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="layout.name_box_left" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="X">
                                <input type="number" v-model.number="layout.name_box_top" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="Y">
                                <input type="number" v-model.number="layout.name_box_width" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å®½åº¦">
                                <input type="number" v-model.number="layout.name_box_height" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="é«˜åº¦">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="layout.name_font_size" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å­—å·">
                                <input type="number" v-model.number="layout.name_padding" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å†…è¾¹è·">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="control-label"><span>å§“åæ é¢œè‰²</span></label>
                                    <input type="color" v-model="layout.name_box_color" class="w-full h-9 rounded-lg cursor-pointer">
                                </div>
                                <div>
                                    <label class="control-label"><span>å§“åæ–‡å­—è‰²</span></label>
                                    <input type="color" v-model="layout.name_text_color" class="w-full h-9 rounded-lg cursor-pointer">
                                </div>
                            </div>
                        </div>
                        <div class="asset-grid p-2 ui-card max-h-[140px] overflow-y-auto">
                            <div @click="layout.border_asset = ''" class="asset-item aspect-square cursor-pointer rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center" :class="layout.border_asset === '' ? 'border-indigo-600 bg-white' : ''">
                                <span class="text-xs font-bold">é»˜è®¤</span>
                            </div>
                            <div v-for="item in assets.borders" class="asset-item aspect-square cursor-pointer rounded-xl border-2 flex items-center justify-center p-1" :class="layout.border_asset === item ? 'border-indigo-600 bg-white' : 'border-transparent'">
                                <div class="asset-delete" @click.stop="deleteAsset('border', item)">Ã—</div>
                                <div class="asset-rename" @click.stop="renameAsset('border', item)">âœ</div>
                                <img @click="layout.border_asset = item" :src="'/api/raw/border/' + item" class="w-full h-full object-contain">
                            </div>
                        </div>
                        <div class="ui-card p-4 space-y-3">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-widest">ä½ç½®ä¸æ ·å¼</div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="layout.box_left" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="X">
                                <input type="number" v-model.number="layout.box_top" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="Y">
                                <input type="number" v-model.number="layout.box_width" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å®½åº¦">
                                <input type="number" v-model.number="layout.box_height" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="é«˜åº¦">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="layout.radius" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="åœ†è§’">
                                <input type="number" v-model.number="layout.padding" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å†…è¾¹è·">
                                <input type="number" v-model.number="layout.font_size" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å­—å·">
                                <input type="color" v-model="layout.text_color" class="bg-slate-100 rounded-lg p-2 h-9">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="control-label"><span>å¯¹è¯æ¡†é¢œè‰²</span></label>
                                    <input type="color" v-model="layout.box_color_base" @input="updateBoxColor" class="w-full h-9 rounded-lg cursor-pointer">
                                </div>
                                <div>
                                    <label class="control-label"><span>æ–‡æœ¬é¢œè‰²</span></label>
                                    <input type="color" v-model="layout.text_color" class="w-full h-9 rounded-lg cursor-pointer">
                                </div>
                            </div>
                            <p class="text-[11px] text-slate-400">æ–‡æœ¬æ¡†ä¹Ÿå¯åœ¨é¢„è§ˆåŒºç›´æ¥æ‹–åŠ¨ã€‚</p>
                        </div>
                    </section>

                    <!-- ç»„ä»¶åº“ -->
                    <section class="space-y-4">
                        <div class="flex justify-between items-center"><h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">ğŸ§© ç»„ä»¶åº“</h4><button @click="triggerUpload('component')" class="text-[10px] px-3 py-1 bg-slate-100 rounded-full font-black">UPLOAD</button></div>
                        <input type="file" id="upload-component" hidden @change="uploadFile($event, 'component')">
                        <div class="ui-card p-3 space-y-2">
                            <div class="text-xs font-black text-slate-500 uppercase tracking-widest">å¿«æ·æ·»åŠ </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button @click="addComponentPreset('avatar')" class="text-[10px] px-2 py-1 rounded-full bg-blue-50 text-blue-700 font-black">å¤´åƒæ¡†</button>
                                <button @click="addComponentPreset('corner')" class="text-[10px] px-2 py-1 rounded-full bg-blue-50 text-blue-700 font-black">è£…é¥°è§’</button>
                                <button @click="addComponentPreset('glow')" class="text-[10px] px-2 py-1 rounded-full bg-blue-50 text-blue-700 font-black">å…‰æ•ˆ</button>
                            </div>
                            <p class="text-[11px] text-slate-400">ä¼šè‡ªåŠ¨åŒ¹é…åç§°åŒ…å«â€œavatar/å¤´åƒ/corner/è§’/glow/å…‰â€çš„ç»„ä»¶ã€‚</p>
                        </div>
                        <div class="asset-grid p-2 ui-card max-h-[140px] overflow-y-auto">
                            <div v-for="item in assets.components" class="asset-item aspect-square cursor-pointer rounded-xl border-2 flex items-center justify-center p-1" :class="selectedOverlay && selectedOverlay.type === 'image' && selectedOverlay.image === item ? 'border-indigo-600 bg-white' : 'border-transparent'">
                                <div class="asset-delete" @click.stop="deleteAsset('component', item)">Ã—</div>
                                <div class="asset-rename" @click.stop="renameAsset('component', item)">âœ</div>
                                <img @click="assignOverlayImage(item)" :src="componentSrc(item)" class="w-full h-full object-contain">
                            </div>
                        </div>
                        <p class="text-[11px] text-slate-400">ç‚¹å‡»ç»„ä»¶å¯å¿«é€Ÿæ›¿æ¢å½“å‰é€‰ä¸­çš„ç»„ä»¶å±‚å›¾ç‰‡ã€‚</p>
                    </section>

                    <!-- å›¾å±‚ç®¡ç† -->
                    <section class="space-y-3">
                        <div class="flex justify-between items-center">
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">ğŸ—‚ï¸ å›¾å±‚ç®¡ç†</h4>
                            <div class="flex gap-2">
                                <button @click="addTextOverlay" class="text-[10px] px-3 py-1 bg-slate-100 rounded-full font-black">+ æ–‡æœ¬å±‚</button>
                                <button @click="addImageOverlay" class="text-[10px] px-3 py-1 bg-slate-100 rounded-full font-black">+ ç»„ä»¶å±‚</button>
                            </div>
                        </div>
                        <div class="ui-card p-2 space-y-2 max-h-[160px] overflow-y-auto">
                            <div v-if="overlays.length === 0" class="text-xs text-slate-400 text-center py-6">æš‚æ— å›¾å±‚</div>
                            <button v-for="item in overlays" :key="item.id" class="w-full text-left px-3 py-2 rounded-xl border text-xs font-semibold flex items-center justify-between"
                                :class="selectedOverlayId === item.id ? 'border-indigo-600 bg-white' : 'border-transparent bg-white/60'"
                                @click="selectOverlay(item.id)">
                                <span>{{ item.type === 'image' ? 'ç»„ä»¶' : 'æ–‡æœ¬' }}å±‚</span>
                                <span class="text-[10px] text-slate-400 truncate max-w-[150px]">{{ item.type === 'image' ? item.image : item.text }}</span>
                            </button>
                        </div>
                        <div v-if="selectedOverlay" class="ui-card p-4 space-y-3 shadow-sm">
                            <div class="flex items-center justify-between">
                                <div class="text-xs font-black text-slate-500 uppercase tracking-widest">ç¼–è¾‘å›¾å±‚</div>
                                <button @click="removeSelectedOverlay" class="text-[10px] px-2 py-1 rounded-full bg-red-50 text-red-600 font-bold">åˆ é™¤</button>
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" v-model.number="selectedOverlay.left" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="X">
                                <input type="number" v-model.number="selectedOverlay.top" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="Y">
                                <input type="number" v-model.number="selectedOverlay.width" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å®½åº¦">
                                <input type="number" v-model.number="selectedOverlay.height" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="é«˜åº¦">
                                <input type="number" v-model.number="selectedOverlay.z_index" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å±‚çº§">
                                <input type="number" v-model.number="selectedOverlay.opacity" min="0" max="1" step="0.05" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="é€æ˜åº¦">
                            </div>
                            <div v-if="selectedOverlay.type === 'text'" class="space-y-2">
                                <textarea v-model="selectedOverlay.text" rows="3" class="w-full bg-slate-100 rounded-lg p-2 text-xs" placeholder="æ–‡æœ¬å†…å®¹"></textarea>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" v-model.number="selectedOverlay.font_size" class="bg-slate-100 rounded-lg p-2 text-xs" placeholder="å­—å·">
                                    <input type="color" v-model="selectedOverlay.color" class="bg-slate-100 rounded-lg p-2 h-9">
                                </div>
                                <select v-model="selectedOverlay.font" class="w-full bg-slate-100 rounded-lg p-2 text-xs">
                                    <option value="">é»˜è®¤å­—ä½“</option>
                                    <option v-for="item in assets.fonts" :key="item" :value="item">{{ item }}</option>
                                </select>
                            </div>
                            <div v-else class="space-y-2">
                                <select v-model="selectedOverlay.image" class="w-full bg-slate-100 rounded-lg p-2 text-xs">
                                    <option value="">è¯·é€‰æ‹©ç»„ä»¶</option>
                                    <option v-for="item in assets.components" :key="item" :value="item">{{ item }}</option>
                                </select>
                            </div>
                        </div>
                    </section>

                </div>
            </div>
        </main>
    </div>
    <script>
        const { createApp, ref, onMounted, computed, watch } = Vue;
        createApp({
            setup() {
                const layout = ref({
                    preset_name: 'default',
                    canvas_width: 1280,
                    canvas_height: 720,
                    background_asset: '',
                    character_asset: '',
                    border_asset: '',
                    character_width: 600,
                    character_left: 340,
                    box_width: 800,
                    box_height: 220,
                    box_left: 240,
                    box_top: 450,
                    box_color: '#000000b4',
                    box_color_base: '#000000',
                    radius: 20,
                    padding: 30,
                    font_size: 28,
                    text_color: '#ffffff',
                    ui_theme: 'blue',
                    show_name_box: true,
                    name_text: 'è§’è‰²å',
                    name_box_width: 220,
                    name_box_height: 56,
                    name_box_left: 540,
                    name_box_top: 90,
                    name_box_color: '#d7e8ffcc',
                    name_text_color: '#1e3a8a',
                    name_font_size: 26,
                    name_padding: 12,
                    name_radius: 16,
                    bg_crop: null,
                    text_overlays: [],
                    model_name: '',
                    model_slots: [],
                    output_mode: 'image_only',
                    enable_dialogue_box: true,
                    prompt_extra: '',
                    negative_prompt: '',
                    negative_prompt_extra: '',
                    output_image_size: '1024x1024',
                    num_inference_steps: 20,
                    cfg_scale: 4.0,
                    background_model: 'Kwai-Kolors/Kolors',
                    enable_ai_background: false,
                    auto_background: false
                });
                const assets = ref({ backgrounds: [], characters: [], borders: [], components: [], presets: [] });
                const models = ref({ default_model: '', models: {} });
                const payloadPreview = ref(null);
                const promptPreview = ref(null);
                const overlays = ref([]);
                const selectedOverlayId = ref(null);
                const selectedOverlay = ref(null);
                const currentPreset = ref('default');
                const previewScale = ref(1.0);
                const resSelection = ref('1280x720');

                // æ‹–æ‹½ç›¸å…³
                const isDragging = ref(false);
                const dragTarget = ref(null);
                const startPos = { x: 0, y: 0, targetX: 0, targetY: 0, overlayId: null };

                const normalizeOverlay = (item) => {
                    const base = {
                        id: `ov_${Date.now()}_${Math.random().toString(16).slice(2, 8)}`,
                        type: 'text',
                        text: 'æ–°æ–‡æœ¬',
                        image: '',
                        left: 120,
                        top: 120,
                        width: 220,
                        height: 80,
                        z_index: 500,
                        opacity: 1,
                        font_size: 24,
                        color: '#ffffff'
                    };
                    if (!item || typeof item !== 'object') return base;
                    return Object.assign(base, item, { id: item.id || base.id, type: item.type || base.type });
                };

                const normalizeOverlays = (items) => {
                    if (!Array.isArray(items)) return [];
                    return items.map((item) => normalizeOverlay(item));
                };

                const fetchAssets = async () => {
                    const data = await (await fetch('/api/assets')).json();
                    data.components = data.components || [];
                                        assets.value = data;
                };
                const fetchModels = async () => {
                    const data = await (await fetch('/api/models')).json();
                    models.value = data || { default_model: '', models: {} };
                    if (!layout.value.model_name) {
                        layout.value.model_name = models.value.default_model || Object.keys(models.value.models || {})[0] || '';
                    }
                    syncModelSlots();
                };

                const activeModelConfig = computed(() => {
                    return (models.value.models || {})[layout.value.model_name] || {};
                });

                const syncModelSlots = () => {
                    const cfgSlots = (activeModelConfig.value && Array.isArray(activeModelConfig.value.slots))
                        ? activeModelConfig.value.slots
                        : [{ key: 'image', role: 'person', weight: 1.0 }];
                    const existing = Array.isArray(layout.value.model_slots) ? layout.value.model_slots : [];
                    const map = {};
                    existing.forEach((s) => {
                        if (s && s.key) map[s.key] = s;
                    });
                    layout.value.model_slots = cfgSlots.map((s) => {
                        const existingSlot = map[s.key] || {};
                        return {
                            key: s.key || 'image',
                            role: existingSlot.role || s.role || 'person',
                            weight: (existingSlot.weight ?? s.weight ?? 1.0),
                            asset: existingSlot.asset || ''
                        };
                    });
                };

                const slotAssets = (role) => {
                    const r = (role || '').toLowerCase();
                    if (r === 'person') return assets.value.characters || [];
                    if (r === 'scene') return assets.value.backgrounds || [];
                    return [];
                };

                const syncCharacterFromSlot = () => {
                    const slots = layout.value.model_slots || [];
                    const imageSlot = slots.find((s) => s && s.key === 'image');
                    if (!imageSlot) return;
                    const role = String(imageSlot.role || '').toLowerCase();
                    if (role !== 'person') return;
                    if (imageSlot.asset !== undefined) {
                        layout.value.character_asset = imageSlot.asset || '';
                    }
                };

                const refreshPayloadPreview = async () => {
                    payloadPreview.value = await (await fetch('/api/payload-preview')).json();
                };
                const refreshPromptPreview = async () => {
                    promptPreview.value = await (await fetch('/api/prompt-preview')).json();
                };
                const deleteAsset = async (type, name) => {
                    if(!confirm(`ç¡®å®šè¦åˆ é™¤ ${name} å—ï¼Ÿ`)) return;
                    await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, name }) });
                    fetchAssets();
                };
                const renameAsset = async (type, name) => {
                    const next = prompt('è¾“å…¥æ–°åç§°ï¼ˆä¸å«è·¯å¾„ï¼‰ï¼š', name);
                    if (!next || next === name) return;
                    await fetch('/api/rename', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, name, new_name: next }) });
                    fetchAssets();
                };
                const createNewPreset = async () => {
                    const name = prompt('è¯·è¾“å…¥æ–°æ–¹æ¡ˆåç§°:');
                    if(!name) return;
                    const res = await (await fetch('/api/presets/new', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) })).json();
                    if(res.status === 'success') {
                        await fetchAssets();
                        currentPreset.value = name;
                        loadLayout();
                    } else {
                        alert('æ–¹æ¡ˆåå·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥');
                    }
                };
                const loadLayout = async () => {
                    const data = await (await fetch('/api/layout?name=' + currentPreset.value)).json();
                    layout.value = Object.assign({}, layout.value, data, { preset_name: currentPreset.value });
                    
                    // æ•°å€¼ç±»å‹è½¬æ¢å’ŒèŒƒå›´é™åˆ¶
                    const clamp = (v, min, max) => Math.min(Math.max(Number(v) || 0, min), max);
                    
                    // ç¡®ä¿ç”»å¸ƒå°ºå¯¸ä¸ºæ­£æ•°
                    layout.value.canvas_width = Math.max(100, Number(layout.value.canvas_width) || 1280);
                    layout.value.canvas_height = Math.max(100, Number(layout.value.canvas_height) || 720);
                    
                    const cw = layout.value.canvas_width;
                    const ch = layout.value.canvas_height;
                    
                    // å¯¹è¯æ¡†å°ºå¯¸ä¸èƒ½è¶…è¿‡ç”»å¸ƒå°ºå¯¸
                    const bw = Number(layout.value.box_width || 0);
                    const bh = Number(layout.value.box_height || 0);
                    if (bw > 0 && bw > cw) layout.value.box_width = cw;
                    if (bh > 0 && bh > ch) layout.value.box_height = ch;
                    
                    // å¯¹è¯æ¡†ä½ç½®é™åˆ¶åœ¨ç”»å¸ƒå†…
                    const maxLeft = Math.max(0, cw - (layout.value.box_width || 0));
                    const maxTop = Math.max(0, ch - (layout.value.box_height || 0));
                    layout.value.box_left = clamp(layout.value.box_left, 0, maxLeft);
                    layout.value.box_top = clamp(layout.value.box_top, 0, maxTop);
                    
                    // è§’è‰²ä½ç½®é™åˆ¶
                    const charW = Number(layout.value.character_width || 0);
                    const minCharLeft = Math.floor(0 - charW / 2);
                    const maxCharLeft = Math.ceil(cw - charW / 2);
                    layout.value.character_left = clamp(layout.value.character_left, minCharLeft, maxCharLeft);
                    
                    if (!layout.value.model_name) {
                        layout.value.model_name = models.value.default_model || Object.keys(models.value.models || {})[0] || '';
                    }
                    syncModelSlots();
                    overlays.value = normalizeOverlays(layout.value.text_overlays);
                    selectedOverlayId.value = null;
                    selectedOverlay.value = null;
                    
                    // é¢œè‰²å¤„ç†
                    if(layout.value.box_color) {
                        layout.value.box_color_base = layout.value.box_color.substring(0,7);
                    }
                    
                    // åˆ†è¾¨ç‡é€‰æ‹©å™¨åŒæ­¥
                    resSelection.value = `${layout.value.canvas_width}x${layout.value.canvas_height}`;
                    if(!['1280x720', '1920x1080', '1024x1024', '720x1280'].includes(resSelection.value)) {
                        resSelection.value = 'custom';
                    }
                    
                    // å»¶è¿Ÿæ›´æ–°ç¼©æ”¾ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                    setTimeout(updateScale, 150);
                };

                const onDragStart = (e, target, id = null) => {
                    e.preventDefault(); // é˜²æ­¢é»˜è®¤çš„æ‹–æ‹½è¡Œä¸º
                    isDragging.value = true;
                    dragTarget.value = target;
                    startPos.x = e.clientX;
                    startPos.y = e.clientY;
                    
                    if(target === 'character') {
                        startPos.targetX = Number(layout.value.character_left) || 0;
                    } else if(target === 'box') {
                        startPos.targetX = Number(layout.value.box_left) || 0;
                        startPos.targetY = Number(layout.value.box_top) || 0;
                    } else if(target === 'name') {
                        startPos.targetX = Number(layout.value.name_box_left) || 0;
                        startPos.targetY = Number(layout.value.name_box_top) || 0;
                    } else if(target === 'overlay') {
                        const overlay = overlays.value.find((item) => item.id === id);
                        if (!overlay) return;
                        selectOverlay(id);
                        startPos.overlayId = id;
                        startPos.targetX = Number(overlay.left) || 0;
                        startPos.targetY = Number(overlay.top) || 0;
                    }
                };
                
                const onDragMove = (e) => {
                    if(!isDragging.value) return;
                    e.preventDefault();
                    
                    // è®¡ç®—é¼ æ ‡ç§»åŠ¨çš„å®é™…åƒç´ è·ç¦»ï¼Œé™¤ä»¥ç¼©æ”¾æ¯”ä¾‹å¾—åˆ°ç”»å¸ƒä¸Šçš„ç§»åŠ¨è·ç¦»
                    const dx = (e.clientX - startPos.x) / previewScale.value;
                    const dy = (e.clientY - startPos.y) / previewScale.value;
                    
                    if(dragTarget.value === 'character') {
                        const newLeft = Math.round(startPos.targetX + dx);
                        const charW = Number(layout.value.character_width || 0);
                        const minLeft = Math.floor(0 - charW / 2);
                        const maxLeft = Math.ceil(layout.value.canvas_width - charW / 2);
                        layout.value.character_left = Math.max(minLeft, Math.min(newLeft, maxLeft));
                    } else if(dragTarget.value === 'box') {
                        const newLeft = Math.round(startPos.targetX + dx);
                        const newTop = Math.round(startPos.targetY + dy);
                        const maxLeft = Math.max(0, layout.value.canvas_width - layout.value.box_width);
                        const maxTop = Math.max(0, layout.value.canvas_height - layout.value.box_height);
                        layout.value.box_left = Math.max(0, Math.min(newLeft, maxLeft));
                        layout.value.box_top = Math.max(0, Math.min(newTop, maxTop));
                    } else if(dragTarget.value === 'name') {
                        const newLeft = Math.round(startPos.targetX + dx);
                        const newTop = Math.round(startPos.targetY + dy);
                        const maxLeft = Math.max(0, layout.value.canvas_width - layout.value.name_box_width);
                        const maxTop = Math.max(0, layout.value.canvas_height - layout.value.name_box_height);
                        layout.value.name_box_left = Math.max(0, Math.min(newLeft, maxLeft));
                        layout.value.name_box_top = Math.max(0, Math.min(newTop, maxTop));
                    } else if(dragTarget.value === 'overlay') {
                        const overlay = overlays.value.find((item) => item.id === startPos.overlayId);
                        if (overlay) {
                            const newLeft = Math.round(startPos.targetX + dx);
                            const newTop = Math.round(startPos.targetY + dy);
                            const maxLeft = Math.max(0, layout.value.canvas_width - (overlay.width || 120));
                            const maxTop = Math.max(0, layout.value.canvas_height - (overlay.height || 80));
                            overlay.left = Math.max(0, Math.min(newLeft, maxLeft));
                            overlay.top = Math.max(0, Math.min(newTop, maxTop));
                        }
                    }
                };
                
                const onDragEnd = () => {
                    isDragging.value = false;
                    dragTarget.value = null;
                    startPos.overlayId = null;
                };

                const saveLayout = async () => {
                    layout.value.text_overlays = overlays.value;
                    await fetch('/api/layout', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(layout.value) });
                    alert('âœ… ä¿å­˜æˆåŠŸ');
                    fetchAssets();
                };
                const triggerUpload = id => document.getElementById('upload-' + id).click();
                const uploadFile = async (e, type) => {
                    const formData = new FormData();
                    formData.append('file', e.target.files[0]);
                    formData.append('type', type);
                    await fetch('/api/upload', { method: 'POST', body: formData });
                    fetchAssets();
                };
                const applyResolution = () => { 
                    if(resSelection.value !== 'custom') { 
                        const [w,h] = resSelection.value.split('x').map(Number); 
                        layout.value.canvas_width = w; 
                        layout.value.canvas_height = h;
                    }
                    // å»¶è¿Ÿè§¦å‘ç¼©æ”¾æ›´æ–°ï¼Œç¡®ä¿DOMå·²æ›´æ–°
                    setTimeout(updateScale, 50);
                };
                
                const onCustomResolutionChange = () => {
                    // è‡ªå®šä¹‰åˆ†è¾¨ç‡è¾“å…¥æ—¶ä¹Ÿéœ€è¦æ›´æ–°ç¼©æ”¾
                    setTimeout(updateScale, 50);
                };
                
                const updateBoxColor = () => { layout.value.box_color = layout.value.box_color_base + 'b4'; };
                const changeBackground = (item) => { layout.value.background_asset = item; layout.value.bg_crop = null; };
                const updateScale = () => {
                    const cnt = document.getElementById('preview-container');
                    const canvas = document.getElementById('canvas-preview');
                    if (!cnt || !canvas) return;
                    
                    const pad = 20;  // ä¸ CSS --preview-pad ä¿æŒä¸€è‡´
                    const w = cnt.clientWidth - pad * 2;
                    const h = cnt.clientHeight - pad * 2;
                    const cw = layout.value.canvas_width || 1;
                    const ch = layout.value.canvas_height || 1;
                    
                    // è®¡ç®—é€‚åº”å®¹å™¨çš„ç¼©æ”¾æ¯”ä¾‹
                    const scaleX = w / cw;
                    const scaleY = h / ch;
                    const fit = Math.min(scaleX, scaleY);
                    
                    // ä½¿ç”¨å®Œæ•´çš„fitæ¯”ä¾‹ï¼Œç¡®ä¿ç”»å¸ƒå®Œæ•´æ˜¾ç¤º
                    // åŒæ—¶ç¡®ä¿æœ€å°ç¼©æ”¾æ¯”ä¾‹ä¸ä½äº0.05ï¼Œé˜²æ­¢ç”»å¸ƒè¿‡å°
                    previewScale.value = Math.max(0.05, fit);

                    // è°ƒè¯•ä¿¡æ¯ï¼šè¾“å‡ºå®¹å™¨å°ºå¯¸å’Œç¼©æ”¾æ¯”ä¾‹
                    console.log('[Preview Scale Debug]', {
                        containerWidth: cnt.clientWidth,
                        containerHeight: cnt.clientHeight,
                        availableWidth: w,
                        availableHeight: h,
                        canvasWidth: cw,
                        canvasHeight: ch,
                        scaleX: scaleX,
                        scaleY: scaleY,
                        fitScale: fit,
                        finalScale: previewScale.value
                    });
                };
                const componentSrc = (name) => name ? `/api/raw/component/${encodeURIComponent(name)}?v=${Date.now()}` : '';
                const overlayStyle = (item) => ({
                    left: (item.left || 0) + 'px',
                    top: (item.top || 0) + 'px',
                    width: (item.width || 120) + 'px',
                    height: (item.height || 120) + 'px',
                    zIndex: item.z_index || 500,
                    opacity: item.opacity ?? 1
                });
                const overlayTextStyle = (item) => ({
                    color: item.color || '#ffffff',
                    fontSize: (item.font_size || 24) + 'px',
                    fontFamily: item.font || 'inherit'
                });
                const fontFaceCss = computed(() => {
                    const fonts = assets.value.fonts || [];
                    return fonts.map((name) => {
                        const encoded = encodeURIComponent(name);
                        return `@font-face { font-family: "${name}"; src: url("/api/raw/font/${encoded}"); }`;
                    }).join('\n');
                });
                const themeClass = computed(() => {
                    const key = String(layout.value.ui_theme || '').trim();
                    return key ? `theme-${key}` : '';
                });

                const selectOverlay = (id) => {
                    selectedOverlayId.value = id;
                    selectedOverlay.value = overlays.value.find((o) => o.id === id) || null;
                };
                const addTextOverlay = () => {
                    const item = normalizeOverlay({ type: 'text', text: 'æ–°æ–‡æœ¬' });
                    overlays.value.push(item);
                    selectOverlay(item.id);
                };
                const addImageOverlay = () => {
                    const item = normalizeOverlay({ type: 'image', image: assets.value.components?.[0] || '' });
                    overlays.value.push(item);
                    selectOverlay(item.id);
                };
                const findComponentByKeywords = (keywords) => {
                    const list = assets.value.components || [];
                    for (const name of list) {
                        const lower = String(name).toLowerCase();
                        if (keywords.some((k) => lower.includes(k) || String(name).includes(k))) {
                            return name;
                        }
                    }
                    return '';
                };
                const addComponentPreset = (kind) => {
                    const cw = Number(layout.value.canvas_width || 0);
                    const ch = Number(layout.value.canvas_height || 0);
                    let keywordSet = [];
                    let w = 240, h = 240, left = 40, top = 40, opacity = 1;
                    if (kind === 'avatar') {
                        keywordSet = ['avatar', 'head', 'portrait', 'å¤´åƒ'];
                        w = 240; h = 240; left = 40; top = 40;
                    } else if (kind === 'corner') {
                        keywordSet = ['corner', 'è§’'];
                        w = 200; h = 200; left = Math.max(0, cw - w - 20); top = 20;
                    } else if (kind === 'glow') {
                        keywordSet = ['glow', 'light', 'å…‰', 'flare'];
                        w = Math.min(600, cw); h = Math.min(260, ch);
                        left = Math.max(0, Math.floor((cw - w) / 2));
                        top = Math.max(0, ch - h - 20);
                        opacity = 0.85;
                    }
                    const comp = findComponentByKeywords(keywordSet);
                    if (!comp) {
                        alert('æœªæ‰¾åˆ°åŒ¹é…ç»„ä»¶ï¼Œè¯·å…ˆä¸Šä¼ å¯¹åº”ç´ æã€‚');
                        return;
                    }
                    const existing = overlays.value.find((o) => o && o.type === 'image' && o.preset_kind === kind);
                    if (existing) {
                        existing.image = comp;
                        existing.left = left;
                        existing.top = top;
                        existing.width = w;
                        existing.height = h;
                        existing.opacity = opacity;
                        selectOverlay(existing.id);
                    } else {
                        const item = normalizeOverlay({
                            type: 'image',
                            image: comp,
                            left,
                            top,
                            width: w,
                            height: h,
                            opacity,
                            preset_kind: kind
                        });
                        overlays.value.push(item);
                        selectOverlay(item.id);
                    }
                };
                const resetDialogueBox = () => {
                    const cw = Number(layout.value.canvas_width || 0);
                    const ch = Number(layout.value.canvas_height || 0);
                    const bw = Number(layout.value.box_width || 0);
                    const bh = Number(layout.value.box_height || 0);
                    // å°†å¯¹è¯æ¡†æ”¾åœ¨ç”»å¸ƒä¸­å¿ƒåä¸‹çš„ä½ç½®ï¼Œæ›´å®¹æ˜“çœ‹åˆ°
                    layout.value.box_left = Math.max(0, Math.floor((cw - bw) / 2));
                    layout.value.box_top = Math.max(0, Math.floor((ch - bh) / 2) + Math.floor(ch * 0.1));
                };

                const applyThemePreset = (theme) => {
                    const presets = {
                        blue: {
                            box_base: '#dbeeff',
                            text: '#1e3a8a',
                            name_box: '#cfe4ff',
                            name_text: '#1e3a8a',
                            border: 'border_blue_style.png',
                            radius: 22,
                            name_radius: 18
                        },
                        wine: {
                            box_base: '#4a0f2b',
                            text: '#ffd6e9',
                            name_box: '#7a123a',
                            name_text: '#ffd6e9',
                            border: 'border_wine_style.png',
                            radius: 22,
                            name_radius: 18
                        },
                        neon: {
                            box_base: '#0b1128',
                            text: '#d6f7ff',
                            name_box: '#121835',
                            name_text: '#a6f6ff',
                            border: 'border_neon_style.png',
                            radius: 18,
                            name_radius: 16
                        }
                    };
                    const preset = presets[theme];
                    if (!preset) return;
                    layout.value.ui_theme = theme;
                    layout.value.box_color_base = preset.box_base;
                    updateBoxColor();
                    layout.value.text_color = preset.text;
                    layout.value.name_box_color = preset.name_box;
                    layout.value.name_text_color = preset.name_text;
                    layout.value.radius = preset.radius;
                    layout.value.name_radius = preset.name_radius;
                    layout.value.border_asset = preset.border;
                };
                const removeSelectedOverlay = () => {
                    if (!selectedOverlayId.value) return;
                    overlays.value = overlays.value.filter((o) => o.id !== selectedOverlayId.value);
                    selectedOverlayId.value = null;
                    selectedOverlay.value = null;
                };
                const assignOverlayImage = (name) => {
                    if (selectedOverlay.value && selectedOverlay.value.type === 'image') {
                        selectedOverlay.value.image = name;
                    }
                };
                
                const canvasStyle = computed(() => ({
                    width: layout.value.canvas_width + 'px',
                    height: layout.value.canvas_height + 'px',
                    transform: 'scale(' + previewScale.value + ')',
                    transformOrigin: 'center center'
                }));
                const previewBgStyle = computed(() => ({ backgroundImage: layout.value.background_asset ? `url(/api/raw/background/${layout.value.background_asset})` : 'none', backgroundSize: 'cover', backgroundPosition: 'center' }));
                const characterLayerStyle = computed(() => {
                    // è§’è‰²å±‚æ ·å¼ï¼šæŒ‰é«˜åº¦ç¼©æ”¾ï¼ˆcharacter_widthç°åœ¨è¡¨ç¤ºç›®æ ‡é«˜åº¦ï¼‰
                    // å®½åº¦ç”±å›¾ç‰‡å®½é«˜æ¯”è‡ªåŠ¨è®¡ç®—
                    return {
                        height: layout.value.character_width + 'px',
                        left: layout.value.character_left + 'px'
                    };
                });
                const boxLayerStyle = computed(() => {
                    return {
                        width: layout.value.box_width + 'px',
                        height: layout.value.box_height + 'px',
                        left: layout.value.box_left + 'px',
                        top: layout.value.box_top + 'px',
                        backgroundColor: layout.value.box_color,
                        borderRadius: layout.value.radius + 'px',
                        padding: layout.value.padding + 'px',
                        backdropFilter: 'blur(10px)',
                        zIndex: 100
                    };
                });
                const textStyle = computed(() => ({ 
                    color: layout.value.text_color, 
                    fontSize: layout.value.font_size + 'px',
                    lineHeight: '1.5'
                }));
                const nameBoxStyle = computed(() => ({
                    width: layout.value.name_box_width + 'px',
                    height: layout.value.name_box_height + 'px',
                    left: layout.value.name_box_left + 'px',
                    top: layout.value.name_box_top + 'px',
                    backgroundColor: layout.value.name_box_color,
                    borderRadius: layout.value.name_radius + 'px',
                    padding: layout.value.name_padding + 'px',
                    display: 'flex',
                    alignItems: 'center',
                    zIndex: 110
                }));
                const nameTextStyle = computed(() => ({
                    color: layout.value.name_text_color,
                    fontSize: layout.value.name_font_size + 'px'
                }));
                
                const showDialogueBox = computed(() => {
                    return Boolean(layout.value.enable_dialogue_box);
                });
                const bgSource = computed({
                    get: () => {
                        if (!layout.value.enable_ai_background) return 'fixed';
                        return layout.value.auto_background ? 'auto' : 'ai';
                    },
                    set: (val) => {
                        if (val === 'fixed') {
                            layout.value.enable_ai_background = false;
                            layout.value.auto_background = false;
                        } else if (val === 'auto') {
                            layout.value.enable_ai_background = true;
                            layout.value.auto_background = true;
                        } else {
                            layout.value.enable_ai_background = true;
                            layout.value.auto_background = false;
                        }
                    }
                });

                onMounted(async () => {
                    await fetchAssets();
                    await fetchModels();
                    await loadLayout();
                    
                    // åˆå§‹åŒ–ç¼©æ”¾
                    setTimeout(updateScale, 100);
                    
                    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
                    window.addEventListener('resize', updateScale);
                    
                    // ç›‘å¬é¢„è§ˆå®¹å™¨å¤§å°å˜åŒ–ï¼ˆæ›´ç²¾ç¡®ï¼‰
                    const cnt = document.getElementById('preview-container');
                    if (cnt && window.ResizeObserver) {
                        const ro = new ResizeObserver(() => {
                            // ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
                            requestAnimationFrame(updateScale);
                        });
                        ro.observe(cnt);
                    }
                });
                watch([() => layout.value.canvas_width, () => layout.value.canvas_height], () => {
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆ
                    setTimeout(updateScale, 50);
                });
                watch(() => layout.value.model_name, () => { syncModelSlots(); });
                watch(() => layout.value.model_slots, () => { syncCharacterFromSlot(); }, { deep: true });
                return { layout, assets, models, payloadPreview, promptPreview, overlays, selectedOverlay, selectedOverlayId, currentPreset, previewScale, resSelection, isDragging, onDragStart, onDragMove, onDragEnd, loadLayout, saveLayout, triggerUpload, uploadFile, deleteAsset, renameAsset, createNewPreset, applyResolution, onCustomResolutionChange, changeBackground, previewBgStyle, canvasStyle, characterLayerStyle, boxLayerStyle, textStyle, nameBoxStyle, nameTextStyle, showDialogueBox, updateBoxColor, componentSrc, overlayStyle, overlayTextStyle, selectOverlay, addTextOverlay, addImageOverlay, addComponentPreset, removeSelectedOverlay, assignOverlayImage, resetDialogueBox, fontFaceCss, fetchModels, syncModelSlots, slotAssets, syncCharacterFromSlot, refreshPayloadPreview, refreshPromptPreview, bgSource, themeClass, applyThemePreset };
            }
        }).mount('#app');
    </script>
</body>
</html>
